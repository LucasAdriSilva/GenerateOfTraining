<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <title>Suporte</title>
    <style>
        body {
            margin-inline: 20px;
        }

        .reset {
            padding-right: 0;
            padding-left: 0;

        }

        .chat {
            display: flex;
            flex-direction: column;
        }

        .chat {
            margin-top: 30px ;
            height: 60vh;
            padding: 5px;
            overflow-y: scroll;
            scroll-behavior: smooth;
            background-color: rgb(250, 236, 223);

        }

        /* Estilizando a barra de rolagem */
        .chat::-webkit-scrollbar {
            width: 8px;
        }

        .chat::-webkit-scrollbar-track {
            background-color: #f1f1f1;
        }

        .chat::-webkit-scrollbar-thumb {
            background-color: #888;
            border-radius: 4px;
        }

        .chat::-webkit-scrollbar-thumb:hover {
            background-color: #555;
        }


        .suport {
            align-self: flex-start;
            background-color: rgb(206, 206, 206);
            padding: 5px 10px 5px 10px;
            border-radius: 10px;
            max-width: 70vw;
            word-wrap: break-word;
            margin-bottom: 10px;
            margin-left: 5px;
        }

        .user {
            width: fit-content;
            word-wrap: break-word;
            max-width: 70vw;
            align-self: flex-end;
            background-color: rgb(231, 189, 111);
            padding: 5px 10px 5px 10px;
            border-radius: 10px;
            margin-left: 10px;
            margin-bottom: 10px;
        }

        .send {
            background-color: rgb(250, 236, 223);
            border-radius: 0px 0px 10px 10px;
            padding: 20px 5px 20px 5px;
        }

        .header {
            background-color: rgb(250, 236, 223);
            border-radius: 10px 10px 0px 0px;
            padding: 10px;
        } 

        .msg {
            font-size: 16px;
        }

        .data-user {
            font-size: 12px;
            align-self: flex-end;
        }

        .data-suport {
            font-size: 12px;
            align-self: flex-start;
        }

        .btn-chat {
            border: none;
            background-color: #ffffff;
            color: black;
            border-radius: 10px;
            padding: 10px 20px 10px 20px;
        }
    </style>
</head>

<body>
    <span class="d-none" id="user">{{data.user}}</span>
    <div class="row mt-3 header">
        <div class="col-12 d-flex flex-column justify-content-center align-content-center">
            <h5 class="text-center">Ticket </h5>
            <h3 id="roomName" class="text-center">{{ data.name }} </h3>
            <small class="text-center">Código de intentificação: {{data.id}}</small>
        </div>
        <div class="col-12 reset">
            <div class="chat"></div>
        </div>
    </div>

    <form style="padding: 0;" id="chat-form" action="">
        <div class="row d-flex justify-content-center algin-items-center send">
            <div class="col-9 d-flex justify-content-center">
                <input type="text" placeholder="Mensagem" name="msg" class="w-100">
            </div>
            <div class="col-3 d-flex justify-content-center">
                <button class="btn btn-success " type="submit">Enviar</button>
            </div>
        </div>
    </form>

    <div class="row" style="background-color: rgb(250, 236, 223);">
        <div class="col-6 d-flex justify-content-center">
            <button class="btn-chat " onclick="window.location.href='/suport'">Voltar</button>
        </div>

        <div class="col-6 d-flex justify-content-center">
            <button class="btn btn-danger rounded-0"
                onclick="desactivateChat('{{data.user}}', '{{data.name}}')">Finalizar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
        integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
        integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"
        integrity="sha512-xbQU0+iHqhVt7VIXi6vBJKPh3IQBF5B84sSHdjKiSccyX/1ZI7Vnkt2/8y8uruj63/DVmCxfUNohPNruthTEQA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>

        function addToChat(msg) {
            const chat = document.querySelector('.chat');

            if (msg.name != 'Suporte') {
                const div = document.createElement("div");
                div.classList.add('user')
                div.classList.add('d-flex')
                div.classList.add('flex-column')
                msg.date != null ? date = msg.date.slice(11, 19).replace('-', ':').replace('-', ':') : date = null

                div.innerHTML = `
                <span class="msg">${msg.message}</span>
                <small class="data-user">${date ? date : ''}</small>
                `
                chat.append(div)

            }
            else {
                const div = document.createElement("div");
                div.classList.add('suport')
                div.classList.add('d-flex')
                div.classList.add('flex-column')
                msg.date != null ? date = msg.date.slice(11, 19).replace('-', ':').replace('-', ':') : date = null

                div.innerHTML = `
                <span class="msg"><strong>Suporte</strong>: ${msg.message}</span>
                <small class="data-suport">${date ? date : ''}</small>
                `
                chat.append(div)
            }
        }


        window.addEventListener('load', function () {
            const roomName = document.querySelector('#roomName').textContent.trim();
            const socket = io('http://127.0.0.1:8085/');

            socket.emit('message', roomName); // Envie o nome da sala usando o evento 'message'

            document.querySelector('#chat-form').addEventListener('submit', function (event) {
                event.preventDefault();
                const user = document.getElementById('user')
                let name = user.innerHTML;
                if (name == 'Lucas') {
                    name = "Suporte"
                }
                const msg = event.target[0].value;
                socket.emit('sendMessage', { name, msg, room: roomName });
                event.target[0].value = '';
            });

            socket.on('getMessages', msg => {
                if (Array.isArray(msg)) {
                    const chat = document.querySelector('.chat');
                    chat.innerHTML = '';
                    msg.forEach(obj => {
                        for (let attribute in obj) {
                            let name = attribute;
                            const { name: newName, date: formattedDate } = removeDateFromName(name);
                            const value = obj[attribute];
                            const formattedMessage = { name: newName, date: formattedDate, message: value };
                            addToChat(formattedMessage);
                        }
                    });
                } else if (typeof msg === 'object') {
                    const chat = document.querySelector('.chat');
                    chat.innerHTML = '';
                    for (let attribute in msg) {
                        let name = attribute;
                        const { name: newName, date: formattedDate } = removeDateFromName(name);
                        const value = msg[attribute];
                        const formattedMessage = { name: newName, date: formattedDate, message: value };
                        addToChat(formattedMessage);
                    }
                }
            });

            function removeDateFromName(name) {
                const regex = /--(\d{4}-\d{2}-\d{2}-\d{2}-\d{2}-\d{2})$/;
                const match = name.match(regex);
                const formattedDate = match ? match[1] : null;
                const newName = name.replace(regex, '');
                return { name: newName, date: formattedDate };
            }

        });

        function desactivateChat(user, name) {
            const socket = io('http://127.0.0.1:8083/');
            socket.emit('desactivateChat', { user, name });
            interval = setInterval(function () {

                window.location.href = '/suport'
            }, 1500);
        }
    </script>
</body>

</html>